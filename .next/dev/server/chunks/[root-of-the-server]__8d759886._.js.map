{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/fausti/Downloads/nuevos-cambios-gonzalo/lib/supabase/server-admin.ts"],"sourcesContent":["import { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\n\n// Server-side admin client that bypasses RLS policies\n// Use this ONLY for trusted server-side operations\nexport async function createAdminClient() {\n  const supabaseUrl = process.env.SUPABASE_URL\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n  if (!supabaseUrl || !supabaseServiceKey) {\n    throw new Error(\"Missing Supabase environment variables for admin client\")\n  }\n\n  return createSupabaseClient(supabaseUrl, supabaseServiceKey, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;;AAIO,eAAe;IACpB,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;QACvC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,yLAAoB,EAAC,aAAa,oBAAoB;QAC3D,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 75, "column": 0}, "map": {"version":3,"sources":["file:///Users/fausti/Downloads/nuevos-cambios-gonzalo/lib/email/resend.ts"],"sourcesContent":["import { Resend } from \"resend\"\n\n// Inicializar cliente de Resend\n// Necesitas agregar RESEND_API_KEY a tu .env.local\nexport const resend = new Resend(process.env.RESEND_API_KEY)\n\n// Email por defecto desde donde se env√≠an los emails\nexport const FROM_EMAIL = process.env.RESEND_FROM_EMAIL || \"onboarding@resend.dev\"\n"],"names":[],"mappings":";;;;;;AAAA;;AAIO,MAAM,SAAS,IAAI,oJAAM,CAAC,QAAQ,GAAG,CAAC,cAAc;AAGpD,MAAM,aAAa,QAAQ,GAAG,CAAC,iBAAiB,IAAI"}},
    {"offset": {"line": 89, "column": 0}, "map": {"version":3,"sources":["file:///Users/fausti/Downloads/nuevos-cambios-gonzalo/lib/email/templates.ts"],"sourcesContent":["interface EmailConfirmacionCompraProps {\n  nombreCliente: string\n  numeroPedido: number\n  numeroSerie?: number\n  monto: number\n  zona: \"cba\" | \"interior\"\n  fechaPago: string\n}\n\nexport function EmailConfirmacionCompra({\n  nombreCliente,\n  numeroPedido,\n  numeroSerie,\n  monto,\n  zona,\n  fechaPago,\n}: EmailConfirmacionCompraProps): string {\n  const fechaFormateada = new Date(fechaPago).toLocaleDateString(\"es-AR\", {\n    day: \"2-digit\",\n    month: \"long\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  })\n\n  // Colores del sitio: turquesa/cyan como primary\n  const primaryColor = \"#00d4ff\"  // Turquesa brillante\n  const accentColor = \"#fbbf24\"   // Amarillo/dorado\n  const darkColor = \"#1a1a1a\"\n\n  return `\n    <!DOCTYPE html>\n    <html lang=\"es\">\n      <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n        <title>¬°Compra Confirmada! - BUZZY √ó TEDDYTWIST</title>\n        <style>\n          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');\n\n          body {\n            margin: 0;\n            padding: 0;\n            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            background-color: #f5f5f5;\n            -webkit-font-smoothing: antialiased;\n            -moz-osx-font-smoothing: grayscale;\n          }\n          .container {\n            max-width: 600px;\n            margin: 0 auto;\n            background-color: #ffffff;\n          }\n          .header {\n            background: linear-gradient(135deg, ${primaryColor} 0%, ${darkColor} 100%);\n            padding: 40px 30px;\n            text-align: center;\n            position: relative;\n            overflow: hidden;\n          }\n          .header::before {\n            content: '';\n            position: absolute;\n            top: -50%;\n            right: -50%;\n            width: 200%;\n            height: 200%;\n            background: repeating-linear-gradient(\n              45deg,\n              transparent,\n              transparent 35px,\n              rgba(255,255,255,0.1) 35px,\n              rgba(255,255,255,0.1) 37px\n            );\n            animation: slide 20s linear infinite;\n          }\n          @keyframes slide {\n            0% { transform: translate(0, 0); }\n            100% { transform: translate(50px, 50px); }\n          }\n          .logo {\n            position: relative;\n            z-index: 1;\n            font-size: 48px;\n            font-weight: 900;\n            color: white;\n            letter-spacing: -2px;\n            margin: 0;\n            text-transform: uppercase;\n          }\n          .logo-subtitle {\n            position: relative;\n            z-index: 1;\n            color: white;\n            font-size: 18px;\n            font-weight: 600;\n            margin-top: 8px;\n            opacity: 0.95;\n          }\n          .badge {\n            display: inline-block;\n            background: linear-gradient(135deg, ${accentColor} 0%, #f59e0b 100%);\n            color: ${darkColor};\n            padding: 8px 20px;\n            border-radius: 50px;\n            font-size: 12px;\n            font-weight: 900;\n            text-transform: uppercase;\n            letter-spacing: 1px;\n            margin-top: 15px;\n            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);\n          }\n          .content {\n            padding: 40px 30px;\n          }\n          .success-icon {\n            text-align: center;\n            font-size: 72px;\n            margin-bottom: 20px;\n          }\n          .title {\n            font-size: 28px;\n            font-weight: 900;\n            color: ${darkColor};\n            text-align: center;\n            margin: 0 0 15px 0;\n            letter-spacing: -1px;\n          }\n          .subtitle {\n            font-size: 16px;\n            color: #666;\n            text-align: center;\n            margin: 0 0 30px 0;\n            line-height: 1.5;\n          }\n          .card {\n            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);\n            border: 2px solid #e5e7eb;\n            border-radius: 16px;\n            padding: 25px;\n            margin: 25px 0;\n          }\n          .detail-row {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 15px 0;\n            border-bottom: 1px solid #e5e7eb;\n          }\n          .detail-row:last-child {\n            border-bottom: none;\n          }\n          .label {\n            color: #6b7280;\n            font-size: 14px;\n            font-weight: 600;\n          }\n          .value {\n            color: ${darkColor};\n            font-size: 16px;\n            font-weight: 700;\n            text-align: right;\n          }\n          .serie-badge {\n            background: linear-gradient(135deg, ${primaryColor} 0%, #0ea5e9 100%);\n            color: white;\n            padding: 6px 16px;\n            border-radius: 25px;\n            font-size: 18px;\n            font-weight: 900;\n            display: inline-block;\n            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);\n          }\n          .total-section {\n            background: linear-gradient(135deg, ${primaryColor} 0%, ${darkColor} 100%);\n            padding: 25px;\n            border-radius: 12px;\n            margin-top: 15px;\n          }\n          .total-label {\n            color: white;\n            font-size: 16px;\n            font-weight: 600;\n            text-align: center;\n            margin: 0;\n          }\n          .total-amount {\n            color: white;\n            font-size: 42px;\n            font-weight: 900;\n            text-align: center;\n            margin: 10px 0 0 0;\n            letter-spacing: -2px;\n          }\n          .highlight-box {\n            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);\n            border-left: 4px solid #10b981;\n            padding: 20px;\n            border-radius: 8px;\n            margin: 25px 0;\n          }\n          .highlight-title {\n            color: #065f46;\n            font-size: 16px;\n            font-weight: 700;\n            margin: 0 0 10px 0;\n          }\n          .highlight-text {\n            color: #047857;\n            font-size: 14px;\n            margin: 0;\n            line-height: 1.6;\n          }\n          .product-image {\n            width: 100%;\n            max-width: 300px;\n            margin: 0 auto 30px;\n            display: block;\n            border-radius: 12px;\n          }\n          .footer {\n            background-color: #1a1a1a;\n            color: #9ca3af;\n            text-align: center;\n            padding: 30px;\n            font-size: 12px;\n          }\n          .footer-link {\n            color: ${primaryColor};\n            text-decoration: none;\n          }\n          .social-links {\n            margin: 20px 0;\n          }\n          .social-link {\n            display: inline-block;\n            margin: 0 10px;\n            color: ${primaryColor};\n            font-size: 14px;\n            text-decoration: none;\n            font-weight: 600;\n          }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <!-- Header -->\n          <div class=\"header\">\n            <h1 class=\"logo\">BUZZY</h1>\n            <p class=\"logo-subtitle\">√ó TEDDYTWIST</p>\n            <div class=\"badge\">EDICI√ìN LIMITADA</div>\n          </div>\n\n          <!-- Content -->\n          <div class=\"content\">\n            <div class=\"success-icon\">‚ú®</div>\n            <h2 class=\"title\">¬°Compra Confirmada!</h2>\n            <p class=\"subtitle\">\n              Hola <strong>${nombreCliente}</strong>,<br>\n              Tu pago ha sido confirmado exitosamente\n            </p>\n\n            <!-- Product Info Card -->\n            <div class=\"card\">\n              <div class=\"detail-row\">\n                <span class=\"label\">Pedido</span>\n                <span class=\"value\">#${String(numeroPedido).padStart(4, '0')}</span>\n              </div>\n\n              ${numeroSerie ? `\n                <div class=\"detail-row\">\n                  <span class=\"label\">N√∫mero de Serie</span>\n                  <span class=\"serie-badge\">${String(numeroSerie).padStart(3, \"0\")}/900</span>\n                </div>\n              ` : ''}\n\n              <div class=\"detail-row\">\n                <span class=\"label\">Fecha</span>\n                <span class=\"value\">${fechaFormateada}</span>\n              </div>\n\n              <div class=\"detail-row\">\n                <span class=\"label\">Env√≠o</span>\n                <span class=\"value\">\n                  ${zona === \"cba\" ? \"üéâ C√≥rdoba - GRATIS\" : \"üì¶ Resto del pa√≠s\"}\n                </span>\n              </div>\n\n              <!-- Total -->\n              <div class=\"total-section\">\n                <p class=\"total-label\">Total Pagado</p>\n                <p class=\"total-amount\">$${monto.toLocaleString(\"es-AR\")}</p>\n              </div>\n            </div>\n\n            <!-- Next Steps -->\n            <div class=\"highlight-box\">\n              <p class=\"highlight-title\">üì¶ Pr√≥ximos Pasos</p>\n              <p class=\"highlight-text\">\n                Tu BUZZY ser√° enviado en los pr√≥ximos 3-5 d√≠as h√°biles.<br>\n                Te notificaremos por email cuando tu pedido sea despachado con el n√∫mero de seguimiento.\n              </p>\n            </div>\n\n            <p style=\"text-align: center; color: #666; font-size: 14px; margin-top: 30px;\">\n              ¬øDudas? Cont√°ctanos y te ayudamos üí¨\n            </p>\n          </div>\n\n          <!-- Footer -->\n          <div class=\"footer\">\n            <p style=\"margin: 0 0 15px 0; color: white; font-weight: 700;\">BUZZY √ó TEDDYTWIST</p>\n            <p style=\"margin: 5px 0;\">Edici√≥n Limitada 900 Unidades</p>\n\n            <div class=\"social-links\">\n              <a href=\"https://www.instagram.com/teddytwist.ok\" class=\"social-link\">Instagram</a>\n            </div>\n\n            <p style=\"margin: 15px 0 0 0; font-size: 11px;\">\n              Este es un correo autom√°tico de confirmaci√≥n de compra.<br>\n              ¬© ${new Date().getFullYear()} TEDDYTWIST. Todos los derechos reservados.\n            </p>\n          </div>\n        </div>\n      </body>\n    </html>\n  `\n}\n\ninterface EmailDatosEnvioProps {\n  nombreCliente: string\n  numeroPedido: number\n  direccion: string\n  ciudad: string\n  provincia: string\n}\n\nexport function EmailDatosEnvioRecibidos({\n  nombreCliente,\n  numeroPedido,\n  direccion,\n  ciudad,\n  provincia,\n}: EmailDatosEnvioProps): string {\n  const primaryColor = \"#00d4ff\"\n  const accentColor = \"#fbbf24\"\n  const darkColor = \"#1a1a1a\"\n\n  return `\n    <!DOCTYPE html>\n    <html lang=\"es\">\n      <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n        <title>Datos de Env√≠o Recibidos - BUZZY √ó TEDDYTWIST</title>\n        <style>\n          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');\n\n          body {\n            margin: 0;\n            padding: 0;\n            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            background-color: #f5f5f5;\n            -webkit-font-smoothing: antialiased;\n          }\n          .container {\n            max-width: 600px;\n            margin: 0 auto;\n            background-color: #ffffff;\n          }\n          .header {\n            background: linear-gradient(135deg, ${primaryColor} 0%, ${darkColor} 100%);\n            padding: 40px 30px;\n            text-align: center;\n            position: relative;\n            overflow: hidden;\n          }\n          .header::before {\n            content: '';\n            position: absolute;\n            top: -50%;\n            right: -50%;\n            width: 200%;\n            height: 200%;\n            background: repeating-linear-gradient(\n              45deg,\n              transparent,\n              transparent 35px,\n              rgba(255,255,255,0.1) 35px,\n              rgba(255,255,255,0.1) 37px\n            );\n          }\n          .logo {\n            position: relative;\n            z-index: 1;\n            font-size: 48px;\n            font-weight: 900;\n            color: white;\n            letter-spacing: -2px;\n            margin: 0;\n            text-transform: uppercase;\n          }\n          .icon {\n            font-size: 64px;\n            margin: 20px 0;\n            position: relative;\n            z-index: 1;\n          }\n          .content {\n            padding: 40px 30px;\n          }\n          .title {\n            font-size: 28px;\n            font-weight: 900;\n            color: ${darkColor};\n            text-align: center;\n            margin: 0 0 15px 0;\n            letter-spacing: -1px;\n          }\n          .subtitle {\n            font-size: 16px;\n            color: #666;\n            text-align: center;\n            margin: 0 0 30px 0;\n            line-height: 1.5;\n          }\n          .card {\n            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);\n            border: 2px solid #e5e7eb;\n            border-radius: 16px;\n            padding: 25px;\n            margin: 25px 0;\n          }\n          .address-title {\n            color: ${darkColor};\n            font-size: 18px;\n            font-weight: 700;\n            margin: 0 0 15px 0;\n          }\n          .pedido-number {\n            background: linear-gradient(135deg, ${accentColor} 0%, #f59e0b 100%);\n            color: ${darkColor};\n            padding: 8px 16px;\n            border-radius: 25px;\n            font-size: 14px;\n            font-weight: 900;\n            display: inline-block;\n            margin-bottom: 20px;\n          }\n          .address-line {\n            color: #374151;\n            font-size: 16px;\n            line-height: 1.8;\n            margin: 5px 0;\n          }\n          .address-city {\n            color: #6b7280;\n            font-size: 14px;\n            margin-top: 10px;\n          }\n          .info-box {\n            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);\n            border-left: 4px solid #3b82f6;\n            padding: 20px;\n            border-radius: 8px;\n            margin: 25px 0;\n          }\n          .info-text {\n            color: #1e40af;\n            font-size: 14px;\n            margin: 0;\n            line-height: 1.6;\n          }\n          .footer {\n            background-color: #1a1a1a;\n            color: #9ca3af;\n            text-align: center;\n            padding: 30px;\n            font-size: 12px;\n          }\n        </style>\n      </head>\n      <body>\n        <div class=\"container\">\n          <!-- Header -->\n          <div class=\"header\">\n            <div class=\"icon\">üìç</div>\n            <h1 class=\"logo\">BUZZY</h1>\n          </div>\n\n          <!-- Content -->\n          <div class=\"content\">\n            <h2 class=\"title\">Datos de Env√≠o Recibidos</h2>\n            <p class=\"subtitle\">\n              Hola <strong>${nombreCliente}</strong>,<br>\n              Hemos confirmado tu direcci√≥n de env√≠o\n            </p>\n\n            <!-- Address Card -->\n            <div class=\"card\">\n              <div class=\"pedido-number\">Pedido #${String(numeroPedido).padStart(4, '0')}</div>\n\n              <p class=\"address-title\">üì¶ Direcci√≥n de Env√≠o</p>\n              <p class=\"address-line\"><strong>${direccion}</strong></p>\n              <p class=\"address-city\">${ciudad}, ${provincia}</p>\n            </div>\n\n            <!-- Info Box -->\n            <div class=\"info-box\">\n              <p class=\"info-text\">\n                <strong>üöö Tu BUZZY est√° en camino</strong><br><br>\n                Prepararemos tu pedido con mucho cuidado y te notificaremos cuando sea despachado con el n√∫mero de seguimiento.\n                <br><br>\n                Tiempo estimado de entrega: 3-5 d√≠as h√°biles\n              </p>\n            </div>\n\n            <p style=\"text-align: center; color: #666; font-size: 14px; margin-top: 30px;\">\n              ¬°Gracias por tu compra! üéâ\n            </p>\n          </div>\n\n          <!-- Footer -->\n          <div class=\"footer\">\n            <p style=\"margin: 0 0 15px 0; color: white; font-weight: 700;\">BUZZY √ó TEDDYTWIST</p>\n            <p style=\"margin: 15px 0 0 0; font-size: 11px;\">\n              ¬© ${new Date().getFullYear()} TEDDYTWIST. Todos los derechos reservados.\n            </p>\n          </div>\n        </div>\n      </body>\n    </html>\n  `\n}\n"],"names":[],"mappings":";;;;;;AASO,SAAS,wBAAwB,EACtC,aAAa,EACb,YAAY,EACZ,WAAW,EACX,KAAK,EACL,IAAI,EACJ,SAAS,EACoB;IAC7B,MAAM,kBAAkB,IAAI,KAAK,WAAW,kBAAkB,CAAC,SAAS;QACtE,KAAK;QACL,OAAO;QACP,MAAM;QACN,MAAM;QACN,QAAQ;IACV;IAEA,gDAAgD;IAChD,MAAM,eAAe,UAAW,qBAAqB;;IACrD,MAAM,cAAc,UAAY,kBAAkB;;IAClD,MAAM,YAAY;IAElB,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;gDAyBsC,EAAE,aAAa,KAAK,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;gDA+ChC,EAAE,YAAY;mBAC3C,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;mBAqBZ,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;mBAmCZ,EAAE,UAAU;;;;;;gDAMiB,EAAE,aAAa;;;;;;;;;;gDAUf,EAAE,aAAa,KAAK,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;mBAsD7D,EAAE,aAAa;;;;;;;;;mBASf,EAAE,aAAa;;;;;;;;;;;;;;;;;;;;;2BAqBP,EAAE,cAAc;;;;;;;;qCAQN,EAAE,OAAO,cAAc,QAAQ,CAAC,GAAG,KAAK;;;cAG/D,EAAE,cAAc,CAAC;;;4CAGa,EAAE,OAAO,aAAa,QAAQ,CAAC,GAAG,KAAK;;cAErE,CAAC,GAAG,GAAG;;;;oCAIe,EAAE,gBAAgB;;;;;;kBAMpC,EAAE,SAAS,QAAQ,wBAAwB,oBAAoB;;;;;;;yCAOxC,EAAE,MAAM,cAAc,CAAC,SAAS;;;;;;;;;;;;;;;;;;;;;;;;;;;;;gBA6BzD,EAAE,IAAI,OAAO,WAAW,GAAG;;;;;;EAMzC,CAAC;AACH;AAUO,SAAS,yBAAyB,EACvC,aAAa,EACb,YAAY,EACZ,SAAS,EACT,MAAM,EACN,SAAS,EACY;IACrB,MAAM,eAAe;IACrB,MAAM,cAAc;IACpB,MAAM,YAAY;IAElB,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;gDAwBsC,EAAE,aAAa,KAAK,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;mBA2C7D,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;mBAoBZ,EAAE,UAAU;;;;;;gDAMiB,EAAE,YAAY;mBAC3C,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;2BAqDJ,EAAE,cAAc;;;;;;iDAMM,EAAE,OAAO,cAAc,QAAQ,CAAC,GAAG,KAAK;;;8CAG3C,EAAE,UAAU;sCACpB,EAAE,OAAO,EAAE,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;gBAsB7C,EAAE,IAAI,OAAO,WAAW,GAAG;;;;;;EAMzC,CAAC;AACH"}},
    {"offset": {"line": 603, "column": 0}, "map": {"version":3,"sources":["file:///Users/fausti/Downloads/nuevos-cambios-gonzalo/app/api/shipping/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { createAdminClient } from \"@/lib/supabase/server-admin\"\nimport { resend, FROM_EMAIL } from \"@/lib/email/resend\"\nimport { EmailConfirmacionCompra, EmailDatosEnvioRecibidos } from \"@/lib/email/templates\"\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const {\n      payment_id,\n      nombre_apellido,\n      email,\n      telefono,\n      dni,\n      provincia,\n      ciudad,\n      direccion_completa,\n      comentarios,\n      comprobante_url,\n    } = body\n\n    console.log(\"[v0] Shipping form received for payment_id:\", payment_id)\n\n    // Validar campos requeridos\n    if (\n      !payment_id ||\n      !nombre_apellido ||\n      !email ||\n      !telefono ||\n      !dni ||\n      !provincia ||\n      !ciudad ||\n      !direccion_completa\n    ) {\n      return NextResponse.json({ error: \"Todos los campos son requeridos\" }, { status: 400 })\n    }\n\n    const supabase = await createAdminClient()\n\n    // Buscar el pedido por payment_id\n    const { data: orderData, error: orderError } = await supabase\n      .from(\"pedidos\")\n      .select(\"*\")\n      .eq(\"payment_id\", payment_id)\n      .eq(\"estado_pago\", \"pagado\")\n      .single()\n\n    if (orderError || !orderData) {\n      console.error(\"[shipping] Order not found:\", orderError)\n      return NextResponse.json({ error: \"Pedido no encontrado o no pagado\" }, { status: 404 })\n    }\n\n    console.log(\"[shipping] Order found:\", orderData.id)\n\n    // Verificar que el pedido no tenga ya un cliente asignado\n    if (orderData.id_cliente) {\n      return NextResponse.json({ error: \"El formulario ya fue completado para este pedido\" }, { status: 400 })\n    }\n\n    // Obtener el n√∫mero de serie de la unidad\n    let numeroSerie = null\n    if (orderData.id_unidad) {\n      const { data: unidad } = await supabase\n        .from(\"unidades_producto\")\n        .select(\"numero_serie\")\n        .eq(\"id\", orderData.id_unidad)\n        .single()\n\n      numeroSerie = unidad?.numero_serie\n    }\n\n    // Crear el cliente con los datos del formulario\n    const { data: clienteData, error: clienteError } = await supabase\n      .from(\"clientes\")\n      .insert({\n        nombre_apellido,\n        email,\n        telefono,\n        dni,\n        provincia,\n        ciudad,\n        direccion_completa,\n      })\n      .select()\n      .single()\n\n    if (clienteError) {\n      console.error(\"[shipping] Error creating client:\", clienteError)\n      return NextResponse.json({ error: \"Error al guardar los datos del cliente\" }, { status: 500 })\n    }\n\n    console.log(\"[shipping] Client created:\", clienteData.id)\n\n    // Actualizar el pedido vincul√°ndolo al cliente y agregando comentarios\n    const { error: updateError } = await supabase\n      .from(\"pedidos\")\n      .update({\n        id_cliente: clienteData.id,\n        comentarios: comentarios || null,\n      })\n      .eq(\"id\", orderData.id)\n\n    if (updateError) {\n      console.error(\"[v0] Error updating shipping info:\", updateError)\n      return NextResponse.json({ error: \"Error al guardar los datos de env√≠o\" }, { status: 500 })\n    }\n\n    console.log(\"[v0] Order updated successfully\")\n\n    // Enviar emails de confirmaci√≥n al cliente\n    try {\n      // Email de confirmaci√≥n de compra\n      const htmlConfirmacion = EmailConfirmacionCompra({\n        nombreCliente: nombre_apellido,\n        numeroPedido: orderData.id,\n        numeroSerie: numeroSerie || undefined,\n        monto: orderData.monto_final,\n        zona: orderData.zona,\n        fechaPago: orderData.fecha_pago || new Date().toISOString(),\n      })\n\n      // Email de confirmaci√≥n de datos de env√≠o\n      const htmlEnvio = EmailDatosEnvioRecibidos({\n        nombreCliente: nombre_apellido,\n        numeroPedido: orderData.id,\n        direccion: direccion_completa,\n        ciudad: ciudad,\n        provincia: provincia,\n      })\n\n      // Enviar ambos emails\n      await Promise.all([\n        resend.emails.send({\n          from: FROM_EMAIL,\n          to: email,\n          subject: `¬°Compra Confirmada! Pedido #${orderData.id} - Buzzy Twist`,\n          html: htmlConfirmacion,\n        }),\n        resend.emails.send({\n          from: FROM_EMAIL,\n          to: email,\n          subject: `Datos de Env√≠o Recibidos - Pedido #${orderData.id}`,\n          html: htmlEnvio,\n        }),\n      ])\n\n      console.log(\"[shipping] Confirmation emails sent successfully to:\", email)\n    } catch (emailError) {\n      console.error(\"[shipping] Error sending confirmation emails:\", emailError)\n      // No bloqueamos el proceso si falla el env√≠o de email\n    }\n\n    // Enviar a Google Sheets\n    let sheetsSuccess = false\n    let sheetsError = null\n\n    try {\n      await sendToGoogleSheets({\n        ...orderData,\n        nombre_apellido,\n        email,\n        telefono,\n        dni,\n        provincia,\n        ciudad,\n        direccion_completa,\n        comentarios,\n        comprobante_url,\n        numero_serie: numeroSerie,\n      })\n      sheetsSuccess = true\n      console.log(\"[v0] Data sent to Google Sheets successfully\")\n    } catch (error) {\n      sheetsError = error\n      console.error(\"[v0] Error sending to Google Sheets:\", error)\n      // No bloqueamos el proceso si falla Google Sheets\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: \"Datos de env√≠o guardados correctamente\",\n      pedido_id: orderData.id,\n      cliente_id: clienteData.id,\n      sheets_status: sheetsSuccess ? \"sent\" : \"failed\",\n      sheets_error: sheetsError ? String(sheetsError) : null,\n    })\n  } catch (error) {\n    console.error(\"[v0] Shipping form error:\", error)\n    return NextResponse.json({ error: \"Error al procesar los datos de env√≠o\", details: String(error) }, { status: 500 })\n  }\n}\n\nasync function sendToGoogleSheets(orderData: any) {\n  const webhookUrl = process.env.GOOGLE_SHEETS_WEBHOOK_URL\n\n  if (!webhookUrl) {\n    const errorMsg = \"Google Sheets webhook URL not configured (GOOGLE_SHEETS_WEBHOOK_URL)\"\n    console.error(\"[v0]\", errorMsg)\n    throw new Error(errorMsg)\n  }\n\n  console.log(\"[v0] üì§ Sending to Google Sheets webhook...\")\n  console.log(\"[v0] Webhook URL:\", webhookUrl)\n\n  const payload = {\n    fecha_hora: new Date().toISOString(),\n    pedido_id: orderData.id || \"\",\n    payment_id: orderData.payment_id || \"\",\n    preference_id: orderData.preference_id || \"\",\n    zona: orderData.zona === \"cba\" ? \"C√≥rdoba Capital\" : \"Interior\",\n    monto_original: orderData.monto_original || 0,\n    monto_descuento: orderData.monto_descuento || 0,\n    monto_final: orderData.monto_final || 0,\n    porcentaje_descuento: orderData.porcentaje_descuento || 0,\n    numero_serie: orderData.numero_serie || \"\",\n    estado_pago: orderData.estado_pago || \"\",\n    nombre_apellido: orderData.nombre_apellido || \"\",\n    email: orderData.email || \"\",\n    telefono: orderData.telefono || \"\",\n    dni: orderData.dni || \"\",\n    provincia: orderData.provincia || \"\",\n    ciudad: orderData.ciudad || \"\",\n    direccion_completa: orderData.direccion_completa || \"\",\n    comentarios: orderData.comentarios || \"\",\n    estado_envio: orderData.estado_envio || \"pendiente\",\n  }\n\n  console.log(\"[v0] üì¶ Payload:\", JSON.stringify(payload, null, 2))\n\n  try {\n    const response = await fetch(webhookUrl, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(payload),\n      redirect: \"follow\", // Follow redirects from Google\n    })\n\n    console.log(\"[v0] üìä Response status:\", response.status)\n    console.log(\"[v0] üìä Response headers:\", Object.fromEntries(response.headers.entries()))\n\n    const responseText = await response.text()\n    console.log(\"[v0] üìä Response body:\", responseText)\n\n    if (!response.ok) {\n      throw new Error(`Google Sheets webhook returned ${response.status}: ${responseText}`)\n    }\n\n    // Try to parse JSON response\n    try {\n      const jsonResponse = JSON.parse(responseText)\n      console.log(\"[v0] üìã Parsed JSON:\", jsonResponse)\n\n      if (!jsonResponse.success) {\n        throw new Error(`Google Sheets returned success=false: ${jsonResponse.error || \"Unknown error\"}`)\n      }\n    } catch (parseError) {\n      // If it's not JSON, check if it's HTML (common error from Google)\n      if (responseText.includes(\"<!DOCTYPE html>\") || responseText.includes(\"<html\")) {\n        console.error(\"[v0] ‚ö†Ô∏è Received HTML instead of JSON - Script may not be properly deployed\")\n        throw new Error(\"Google Sheets script not properly deployed as Web App. Please check deployment settings.\")\n      }\n      // If status is 200 and it's not HTML, accept it\n      console.log(\"[v0] ‚ÑπÔ∏è Response is not JSON but status is OK\")\n    }\n\n    console.log(\"[v0] ‚úÖ Successfully sent to Google Sheets\")\n    return true\n  } catch (error) {\n    console.error(\"[v0] ‚ùå Failed to send to Google Sheets:\", error)\n    if (error instanceof Error) {\n      console.error(\"[v0] Error message:\", error.message)\n      console.error(\"[v0] Error stack:\", error.stack)\n    }\n    throw error\n  }\n}\n"],"names":[],"mappings":"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"}}]
}