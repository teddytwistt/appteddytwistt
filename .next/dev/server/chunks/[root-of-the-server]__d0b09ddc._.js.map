{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/fausti/Downloads/nuevos-cambios-gonzalo/lib/supabase/server-admin.ts"],"sourcesContent":["import { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\n\n// Server-side admin client that bypasses RLS policies\n// Use this ONLY for trusted server-side operations\nexport async function createAdminClient() {\n  const supabaseUrl = process.env.SUPABASE_URL\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n  if (!supabaseUrl || !supabaseServiceKey) {\n    throw new Error(\"Missing Supabase environment variables for admin client\")\n  }\n\n  return createSupabaseClient(supabaseUrl, supabaseServiceKey, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;;AAIO,eAAe;IACpB,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;QACvC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,yLAAoB,EAAC,aAAa,oBAAoB;QAC3D,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///Users/fausti/Downloads/nuevos-cambios-gonzalo/lib/utils/timezone.ts"],"sourcesContent":["/**\n * Utilidades para manejar zonas horarias\n * Argentina usa UTC-3 (ART - Argentina Time)\n */\n\n/**\n * Obtiene la fecha y hora actual en zona horaria de Argentina (UTC-3)\n * y la retorna en formato ISO compatible con Supabase timestamptz\n */\nexport function getArgentinaTimestamp(): string {\n  const now = new Date()\n\n  // Convertir a hora de Argentina (UTC-3)\n  // Crear un formatter con timezone de Argentina\n  const argentinaTime = new Date(now.toLocaleString('en-US', {\n    timeZone: 'America/Argentina/Buenos_Aires'\n  }))\n\n  return argentinaTime.toISOString()\n}\n\n/**\n * Convierte una fecha UTC a hora de Argentina\n */\nexport function toArgentinaTime(utcDate: Date | string): Date {\n  const date = typeof utcDate === 'string' ? new Date(utcDate) : utcDate\n\n  return new Date(date.toLocaleString('en-US', {\n    timeZone: 'America/Argentina/Buenos_Aires'\n  }))\n}\n\n/**\n * Formatea una fecha para mostrar en zona horaria de Argentina\n */\nexport function formatArgentinaDateTime(dateString: string): string {\n  return new Date(dateString).toLocaleString(\"es-AR\", {\n    timeZone: 'America/Argentina/Buenos_Aires',\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  })\n}\n"],"names":[],"mappings":"AAAA;;;CAGC,GAED;;;CAGC;;;;;;;;AACM,SAAS;IACd,MAAM,MAAM,IAAI;IAEhB,wCAAwC;IACxC,+CAA+C;IAC/C,MAAM,gBAAgB,IAAI,KAAK,IAAI,cAAc,CAAC,SAAS;QACzD,UAAU;IACZ;IAEA,OAAO,cAAc,WAAW;AAClC;AAKO,SAAS,gBAAgB,OAAsB;IACpD,MAAM,OAAO,OAAO,YAAY,WAAW,IAAI,KAAK,WAAW;IAE/D,OAAO,IAAI,KAAK,KAAK,cAAc,CAAC,SAAS;QAC3C,UAAU;IACZ;AACF;AAKO,SAAS,wBAAwB,UAAkB;IACxD,OAAO,IAAI,KAAK,YAAY,cAAc,CAAC,SAAS;QAClD,UAAU;QACV,KAAK;QACL,OAAO;QACP,MAAM;QACN,MAAM;QACN,QAAQ;IACV;AACF"}},
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///Users/fausti/Downloads/nuevos-cambios-gonzalo/app/api/payment/validate/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { createAdminClient } from \"@/lib/supabase/server-admin\"\nimport { getArgentinaTimestamp } from \"@/lib/utils/timezone\"\n\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams\n    const paymentId = searchParams.get(\"payment_id\")\n    const preferenceId = searchParams.get(\"preference_id\")\n\n    if (!paymentId || !preferenceId) {\n      return NextResponse.json({ error: \"Parámetros faltantes\" }, { status: 400 })\n    }\n\n    // Consultar la API de Mercado Pago\n    const accessToken = process.env.MERCADO_PAGO_ACCESS_TOKEN\n\n    if (!accessToken) {\n      return NextResponse.json({ error: \"Configuración de pago no disponible\" }, { status: 500 })\n    }\n\n    const response = await fetch(`https://api.mercadopago.com/v1/payments/${paymentId}`, {\n      method: \"GET\",\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n      },\n    })\n\n    if (!response.ok) {\n      console.error(\"[v0] Mercado Pago validation error:\", response.status)\n      return NextResponse.json({ error: \"Error al validar el pago\" }, { status: 500 })\n    }\n\n    const paymentData = await response.json()\n\n    // Verificar que el pago esté aprobado\n    if (paymentData.status !== \"approved\") {\n      return NextResponse.json(\n        {\n          success: false,\n          message: \"El pago no ha sido aprobado\",\n          status: paymentData.status,\n        },\n        { status: 200 },\n      )\n    }\n\n    // Buscar el pedido en la base de datos\n    const supabase = await createAdminClient()\n\n    const { data: orderData, error: orderError } = await supabase\n      .from(\"pedidos\")\n      .select(\"*\")\n      .eq(\"preference_id\", preferenceId)\n      .single()\n\n    if (orderError || !orderData) {\n      console.error(\"[payment-validate] Order not found:\", orderError)\n      return NextResponse.json({ error: \"Pedido no encontrado\" }, { status: 404 })\n    }\n\n    // Verificar que el monto coincida (usar monto_final)\n    if (paymentData.transaction_amount !== orderData.monto_final) {\n      console.error(\"[payment-validate] Amount mismatch:\", {\n        expected: orderData.monto_final,\n        received: paymentData.transaction_amount,\n      })\n      return NextResponse.json({ error: \"El monto del pago no coincide\" }, { status: 400 })\n    }\n\n    // Actualizar el pedido con la información del pago\n    const { error: updateError } = await supabase\n      .from(\"pedidos\")\n      .update({\n        estado_pago: \"pagado\",\n        payment_id: paymentId,\n        fecha_pago: getArgentinaTimestamp(),\n        mp_response: paymentData,\n      })\n      .eq(\"id\", orderData.id)\n\n    if (updateError) {\n      console.error(\"[payment-validate] Error updating order:\", updateError)\n      return NextResponse.json({ error: \"Error al actualizar el pedido\" }, { status: 500 })\n    }\n\n    // Marcar la unidad como vendida\n    if (orderData.id_unidad) {\n      const { error: unidadError } = await supabase.rpc(\"marcar_unidad_vendida\", {\n        p_id_unidad: orderData.id_unidad,\n      })\n\n      if (unidadError) {\n        console.error(\"[payment-validate] Error marking unit as sold:\", unidadError)\n        // No fallar el proceso si esto falla, solo logear\n      } else {\n        console.log(\"[payment-validate] Unit marked as sold:\", orderData.id_unidad)\n      }\n    }\n\n    // Obtener el número de serie de la unidad\n    let numeroSerie = null\n    if (orderData.id_unidad) {\n      const { data: unidad } = await supabase\n        .from(\"unidades_producto\")\n        .select(\"numero_serie\")\n        .eq(\"id\", orderData.id_unidad)\n        .single()\n\n      numeroSerie = unidad?.numero_serie\n    }\n\n    console.log(\"[payment-validate] Payment validated successfully for order:\", orderData.id)\n\n    return NextResponse.json({\n      success: true,\n      message: \"Pago validado correctamente\",\n      pedido: {\n        id: orderData.id,\n        zona: orderData.zona,\n        monto_final: orderData.monto_final,\n        numero_serie: numeroSerie,\n      },\n    })\n  } catch (error) {\n    console.error(\"[v0] Payment validation error:\", error)\n    return NextResponse.json({ error: \"Error al validar el pago\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}