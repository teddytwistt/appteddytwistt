{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/fausti/Downloads/nuevos-cambios-gonzalo/lib/supabase/server-admin.ts"],"sourcesContent":["import { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\n\n// Server-side admin client that bypasses RLS policies\n// Use this ONLY for trusted server-side operations\nexport async function createAdminClient() {\n  const supabaseUrl = process.env.SUPABASE_URL\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n  if (!supabaseUrl || !supabaseServiceKey) {\n    throw new Error(\"Missing Supabase environment variables for admin client\")\n  }\n\n  return createSupabaseClient(supabaseUrl, supabaseServiceKey, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;;AAIO,eAAe;IACpB,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;QACvC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,yLAAoB,EAAC,aAAa,oBAAoB;QAC3D,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///Users/fausti/Downloads/nuevos-cambios-gonzalo/app/api/checkout/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { createAdminClient } from \"@/lib/supabase/server-admin\"\n\nconst PRODUCTO_ID = 1 // ID del producto Buzzy Twist\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { zona, discountCode, discountPercentage, idDescuento } = body\n\n    if (!zona || (zona !== \"cba\" && zona !== \"interior\")) {\n      return NextResponse.json({ error: \"Zona inválida\" }, { status: 400 })\n    }\n\n    const supabase = await createAdminClient()\n\n    // Obtener precios del producto desde la base de datos\n    const { data: producto, error: productoError } = await supabase\n      .from(\"productos\")\n      .select(\"precio_cba, precio_interior\")\n      .eq(\"id\", PRODUCTO_ID)\n      .single()\n\n    if (productoError || !producto) {\n      console.error(\"[checkout] Error fetching product prices:\", productoError)\n      return NextResponse.json({ error: \"Error al obtener precios del producto\" }, { status: 500 })\n    }\n\n    // Verificar stock disponible usando la función obtener_stock_disponible\n    const { data: stockData, error: stockError } = await supabase\n      .rpc(\"obtener_stock_disponible\", {\n        p_id_producto: PRODUCTO_ID,\n      })\n\n    if (stockError) {\n      console.error(\"[checkout] Error checking stock:\", stockError)\n      return NextResponse.json({ error: \"Error al verificar stock\" }, { status: 500 })\n    }\n\n    if (!stockData || stockData.length === 0 || stockData[0].disponibles <= 0) {\n      return NextResponse.json({ error: \"Producto agotado\" }, { status: 400 })\n    }\n\n    // Calcular montos usando los precios de la base de datos\n    const montoOriginal = zona === \"cba\" ? producto.precio_cba : producto.precio_interior\n    let montoDescuento = 0\n    let montoFinal = montoOriginal\n\n    if (discountPercentage && discountPercentage > 0) {\n      montoDescuento = Math.round((montoOriginal * discountPercentage) / 100)\n      montoFinal = montoOriginal - montoDescuento\n      console.log(\n        `[checkout] Discount applied: ${discountPercentage}% - Original: $${montoOriginal}, Descuento: $${montoDescuento}, Final: $${montoFinal}`\n      )\n    }\n\n    const preference = await createMercadoPagoPreference(\n      zona,\n      montoFinal,\n      montoOriginal,\n      discountCode,\n      discountPercentage\n    )\n\n    if (!preference.id || !preference.init_point) {\n      return NextResponse.json({ error: \"Error al crear preferencia de pago\" }, { status: 500 })\n    }\n\n    // Reservar una unidad disponible\n    const { data: unidadReservada, error: unidadError } = await supabase.rpc(\"reservar_unidad_disponible\", {\n      p_id_producto: PRODUCTO_ID,\n    })\n\n    if (unidadError || !unidadReservada || unidadReservada.length === 0) {\n      console.error(\"[checkout] Error reserving unit:\", unidadError)\n      return NextResponse.json({ error: \"No hay stock disponible\" }, { status: 400 })\n    }\n\n    const unidad = unidadReservada[0]\n    console.log(\"[checkout] Unit reserved:\", unidad.id_unidad, \"Serial:\", unidad.numero_serie)\n\n    // Crear el pedido con la unidad reservada\n    const { data: orderData, error: orderError } = await supabase\n      .from(\"pedidos\")\n      .insert({\n        preference_id: preference.id,\n        id_producto: PRODUCTO_ID,\n        id_unidad: unidad.id_unidad,\n        zona,\n        monto_original: montoOriginal,\n        porcentaje_descuento: discountPercentage || 0,\n        monto_descuento: montoDescuento,\n        monto_final: montoFinal,\n        estado_pago: \"pendiente\",\n        estado_envio: \"pendiente\",\n        id_codigo_descuento: idDescuento || null,\n      })\n      .select()\n      .single()\n\n    if (orderError) {\n      console.error(\"[checkout] Error creating order:\", orderError)\n      // Liberar la unidad si falla la creación del pedido\n      await supabase.rpc(\"liberar_unidad\", { p_id_unidad: unidad.id_unidad })\n      return NextResponse.json({ error: \"Error al crear pedido\" }, { status: 500 })\n    }\n\n    console.log(\"[checkout] Order created successfully:\", orderData.id, \"Unit:\", unidad.id_unidad)\n\n    return NextResponse.json({\n      init_point: preference.init_point,\n      preference_id: preference.id,\n      pedido_id: orderData.id,\n    })\n  } catch (error) {\n    console.error(\"[checkout] Checkout error:\", error)\n    return NextResponse.json({ error: \"Error en el proceso de checkout\" }, { status: 500 })\n  }\n}\n\nasync function createMercadoPagoPreference(\n  zona: string,\n  monto: number,\n  montoOriginal: number,\n  discountCode: string | null,\n  discountPercentage: number | null,\n) {\n  const accessToken = process.env.MERCADO_PAGO_ACCESS_TOKEN\n\n  if (!accessToken) {\n    throw new Error(\"Mercado Pago access token not configured\")\n  }\n\n  const formUrl = process.env.NEXT_PUBLIC_FORM_URL\n\n  if (!formUrl) {\n    console.error(\"[v0] NEXT_PUBLIC_FORM_URL not configured\")\n    throw new Error(\"NEXT_PUBLIC_FORM_URL environment variable is required\")\n  }\n\n  console.log(\"[v0] Creating preference with form URL:\", formUrl)\n\n  let description = zona === \"cba\" ? \"Envío gratis - Córdoba Capital\" : \"Incluye envío - Resto del país\"\n  if (discountCode && discountPercentage) {\n    description += ` | Descuento ${discountPercentage}% aplicado (${discountCode})`\n  }\n\n  const preferenceData = {\n    items: [\n      {\n        title: \"Buzzy Twist - Edición Limitada\",\n        description,\n        quantity: 1,\n        unit_price: monto, // Use discounted price\n        currency_id: \"ARS\",\n      },\n    ],\n    back_urls: {\n      success: `${formUrl}/checkout/success`,\n      failure: `${formUrl}/checkout/failure`,\n      pending: `${formUrl}/checkout/pending`,\n    },\n    auto_return: \"approved\",\n    external_reference: zona,\n    statement_descriptor: \"BUZZY TWIST\",\n    payment_methods: {\n      excluded_payment_methods: [],\n      excluded_payment_types: [],\n      installments: 1,\n    },\n    additional_info: `Completá tus datos de envío en: ${formUrl}`,\n  }\n\n  console.log(\"[v0] Preference data:\", JSON.stringify(preferenceData, null, 2))\n\n  const response = await fetch(\"https://api.mercadopago.com/checkout/preferences\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      Authorization: `Bearer ${accessToken}`,\n    },\n    body: JSON.stringify(preferenceData),\n  })\n\n  if (!response.ok) {\n    const errorText = await response.text()\n    console.error(\"[v0] Mercado Pago error:\", errorText)\n    throw new Error(`Mercado Pago API error: ${response.status} - ${errorText}`)\n  }\n\n  const result = await response.json()\n  console.log(\"[v0] Preference created:\", result.id)\n\n  return result\n}\n"],"names":[],"mappings":"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"}}]
}